<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/externalAPIs/confluenceSite.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/externalAPIs/confluenceSite.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import apiUse from "./genericAPIUse";
import configuration from "../configuration";
import confluenceSiteScheme from "../../model/confluenceSite";


/** Module to handle creation, modification, files uploads and deletion of confluence sites
* @module modules/externalAPIs/confluenceSite
*/

/**
* @function callApiFunction
* @description Preparation to call the Confluence API. So you don't have to copy&amp;paste it all over the place
* @param {String} apiMethod Request method to use
* @param {String} apiEndpoint Which Confluence API-Endpoint to call
* @param {Object} apiPostData Data to send to the Confluence API-Endpoint
* @return {Promise} always returns a solved Promise.
*/
const callApiFunction = ({apiMethod = "get", apiEndpoint = "", apiPostData = {}} = {}) => {
  return new Promise((resolve, reject) => {
    apiUse.use({
      method: apiMethod,
      url: `${configuration.DMSUrl}${apiEndpoint}`,
      headers: {"Authorization": "Basic " + Buffer.from(configuration.DMSUserEmail + ":" + configuration.DMSAPIToken).toString("base64")},
      body: apiPostData,
    })
        .then((result) => {
          resolve(result);
        });
  });
};

/**
* @function createSiteFunction
* @description creates a Content-Type of "page" in Confluence
* @param {String} titleName The title for the page
* @param {String} parentID has the page a parent site? ID goes of the parent site here
* @param {string} spaceKey in which space should the site be created in
* @param {string} content the actual content of the page in representation-form "wiki"
* @return {Promise} always returns a solved Promise.
*/
const createSiteFunction = ({titleName = "Platzhalter-Titel", parentID = "", spaceKey = "PROT", content = "Lorem ipsum dolor sit amet."} = {}) => {
  let postData = {
    title: titleName,
    type: "page",
    status: "current",
    space: {
      key: spaceKey,
    },
    body: {
      wiki: {
        value: content,
        representation: "wiki",
      },
    },
  };

  if (!parentID === "") {
    postData = {
      ...postData,
      ancestors: [{
        id: parentID,
      }],
    };
  }

  return new Promise((resolve, reject) => {
    confluenceSiteScheme.createContentScheme.validate(postData)
        .then(() => {
          return callApiFunction({apiMethod: "post", apiEndpoint: "/rest/api/content", apiPostData: postData});
        })
        .then((result) => {
          let message = {
            userNotification: result.data.message,
            apiPayload: {link: "error", title: "error", ...result.data},
          };
          if (result.statusCode == 200) {
            message = {
              userNotification: `Your site is created. URL: &lt;a href="${result.data._links.base}${result.data._links.webui}">${result.data._links.base}${result.data._links.webui}&lt;/a>`,
              apiPayload: {link: `${result.data._links.base}${result.data._links.webui}`, title: result.data.title},
            };
          }
          resolve({statusCode: result.statusCode, data: message});
        });
  });
};

/**
* @function updateSiteFunction
* @description Updates the content of a Content-Type of "page" in Confluence
* @param {String} titleName The title for the page
* @param {String} id the number that specifies the to be updated site
* @param {string} content the actual content of the page in representation-form "wiki"
* @return {Promise} always returns a solved Promise.
*/
const updateSiteFunction = ({titleName = "Platzhalter-Titel", id = "", content = "updated"} = {}) => {
  let postData = {
    title: titleName,
    type: "page",
    status: "current",
    body: {
      wiki: {
        value: content,
        representation: "wiki",
      },
    },
  };
  return new Promise((resolve, reject) => {
    readSiteFunction({id: id})
        .then((result) => {
          if (result.statusCode == 200) {
            postData = {
              ...postData,
              version: {
                number: result.data.apiPayload.version.number + 1,
              },
            };
            return callApiFunction({apiMethod: "put", apiEndpoint: `/rest/api/content/${id}`, apiPostData: postData});
          } else {
            return new Promise((resolve, reject) => {
              resolve(result);
            });
          }
        })
        .then((result) => {
          let message = {
            userNotification: result.data.message,
            apiPayload: {link: "error", title: "error", ...result.data},
          };
          if (result.statusCode == 200) {
            message = {
              userNotification: `Your site is updated. URL: &lt;a href="${result.data._links.base}${result.data._links.webui}">${result.data._links.base}${result.data._links.webui}&lt;/a>`,
              apiPayload: {link: `${result.data._links.base}${result.data._links.webui}`, title: result.data.title},
            };
          }
          resolve({statusCode: result.statusCode, data: message});
        });
  });
};

/**
* @function readsSiteFunction
* @description reads the content of a Content-Type of "page" in Confluence
* @param {String} id the number that specifies the to be read site
* @return {Promise} always returns a solved Promise.
*/
const readSiteFunction = ({id = ""} = {}) => {
  return new Promise((resolve, reject) => {
    callApiFunction({apiMethod: "get", apiEndpoint: `/rest/api/content/${id}`})
        .then((result) => {
          let message = {
            userNotification: result.data.message,
            apiPayload: {id: "error", title: "error", type: "error", ...result.data},
          };
          if (result.statusCode == 200) {
            message = {
              userNotification: `here is your site data: &lt;pre>&lt;code>${JSON.stringify(result.data, undefined, 4)}&lt;/code>&lt;/pre>`,
              apiPayload: result.data,
            };
          }
          resolve({statusCode: result.statusCode, data: message});
        });
  });
};


/**
* @function deleteSiteFunction
* @description deletes a Content-Type of "page" in Confluence
* @param {String} id the number that specifies the to be deleted site
* @return {Promise} always returns a solved Promise.
*/
const deleteSiteFunction = ({id = ""} = {}) => {
  return new Promise((resolve, reject) => {
    callApiFunction({apiMethod: "delete", apiEndpoint: `/rest/api/content/${id}`})
        .then((result) => {
          let message = {
            userNotification: result.data.message,
            apiPayload: {id: "error", title: "error", type: "error", ...result.data},
          };
          if (result.statusCode == 204) {
            message = {
              userNotification: "the site was deleted",
              apiPayload: {},
            };
          }
          resolve({statusCode: result.statusCode, data: message});
        });
  });
};

export default {
  createSite: createSiteFunction,
  readSite: readSiteFunction,
  updateSite: updateSiteFunction,
  deleteSite: deleteSiteFunction,
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-controller_DMS_DMSController.html">controller/DMS/DMSController</a></li><li><a href="module-datamodel_configuration.html">datamodel/configuration</a></li><li><a href="module-datamodel_confluenceSite.html">datamodel/confluenceSite</a></li><li><a href="module-datamodel_DMSAttachments.html">datamodel/DMSAttachments</a></li><li><a href="module-modules_app.html">modules/app</a></li><li><a href="module-modules_configuration.html">modules/configuration</a></li><li><a href="module-modules_cors.html">modules/cors</a></li><li><a href="module-modules_externalAPIs_confluenceSite.html">modules/externalAPIs/confluenceSite</a></li><li><a href="module-modules_externalAPIs_gnericAPIUse.html">modules/externalAPIs/gnericAPIUse</a></li><li><a href="module-modules_privateRoutes.html">modules/privateRoutes</a></li><li><a href="module-routes_VPERoutes.html">routes/VPERoutes</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Wed Jan 12 2022 09:23:37 GMT+0100 (Mitteleurop√§ische Normalzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
